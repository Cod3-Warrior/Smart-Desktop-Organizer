<UserControl x:Class="SmartDesktopOrganizer.Controls.AppItem"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:converters="clr-namespace:SmartDesktopOrganizer.Converters"
             mc:Ignorable="d" 
             d:DesignHeight="200" d:DesignWidth="200">
    <UserControl.Resources>
        <Style TargetType="Border" x:Key="IconBorderStyle">
            <Setter Property="CornerRadius" Value="16"/>
            <Setter Property="Background" Value="#2C2C2C"/>
            <Setter Property="Effect">
                <Setter.Value>
                    <DropShadowEffect BlurRadius="10" ShadowDepth="2" Opacity="0.3" Color="Black"/>
                </Setter.Value>
            </Setter>
        </Style>
        
        <!-- Frosted glass for folders -->
        <Style TargetType="Border" x:Key="FrostedGlassStyle">
            <Setter Property="Background" Value="#35FFFFFF"/>
            <Setter Property="CornerRadius" Value="16"/>
            <Setter Property="Effect">
                <Setter.Value>
                    <DropShadowEffect BlurRadius="15" ShadowDepth="3" Opacity="0.4" Color="Black"/>
                </Setter.Value>
            </Setter>
        </Style>
        
        <!-- QuickLaunch button style -->
        <Style TargetType="Button" x:Key="QuickLaunchSlot">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border Background="{TemplateBinding Background}" 
                                CornerRadius="8" Padding="2"
                                x:Name="SlotBorder">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="SlotBorder" Property="Background" Value="#30FFFFFF"/>
                            </Trigger>
                            <Trigger Property="IsPressed" Value="True">
                                <Setter TargetName="SlotBorder" Property="Background" Value="#50FFFFFF"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
        
        <!-- Visibility converter -->
        <converters:BoolToVisibilityConverter x:Key="BoolToVis"/>
        
        <!-- Animation Storyboards -->
        <Storyboard x:Key="JiggleStoryboard" RepeatBehavior="Forever" AutoReverse="True">
            <DoubleAnimation Storyboard.TargetName="MainContainer" 
                             Storyboard.TargetProperty="(UIElement.RenderTransform).(TransformGroup.Children)[2].(RotateTransform.Angle)"
                             From="-2" To="2" Duration="0:0:0.1"/>
        </Storyboard>
        
        <Storyboard x:Key="EnlargeStoryboard">
            <DoubleAnimationUsingKeyFrames Storyboard.TargetName="MainContainer" 
                                           Storyboard.TargetProperty="(UIElement.RenderTransform).(TransformGroup.Children)[0].(ScaleTransform.ScaleX)">
                <EasingDoubleKeyFrame KeyTime="0:0:0" Value="0.7"/>
                <EasingDoubleKeyFrame KeyTime="0:0:0.25" Value="1.0">
                    <EasingDoubleKeyFrame.EasingFunction><CubicEase EasingMode="EaseOut"/></EasingDoubleKeyFrame.EasingFunction>
                </EasingDoubleKeyFrame>
            </DoubleAnimationUsingKeyFrames>
            <DoubleAnimationUsingKeyFrames Storyboard.TargetName="MainContainer" 
                                           Storyboard.TargetProperty="(UIElement.RenderTransform).(TransformGroup.Children)[0].(ScaleTransform.ScaleY)">
                <EasingDoubleKeyFrame KeyTime="0:0:0" Value="0.7"/>
                <EasingDoubleKeyFrame KeyTime="0:0:0.25" Value="1.0">
                    <EasingDoubleKeyFrame.EasingFunction><CubicEase EasingMode="EaseOut"/></EasingDoubleKeyFrame.EasingFunction>
                </EasingDoubleKeyFrame>
            </DoubleAnimationUsingKeyFrames>
        </Storyboard>
        
        <Storyboard x:Key="ShrinkStoryboard">
            <DoubleAnimationUsingKeyFrames Storyboard.TargetName="MainContainer" 
                                           Storyboard.TargetProperty="(UIElement.RenderTransform).(TransformGroup.Children)[0].(ScaleTransform.ScaleX)">
                <EasingDoubleKeyFrame KeyTime="0:0:0" Value="1.0"/>
                <EasingDoubleKeyFrame KeyTime="0:0:0.2" Value="0.7"/>
                <EasingDoubleKeyFrame KeyTime="0:0:0.25" Value="1.0">
                    <EasingDoubleKeyFrame.EasingFunction><CubicEase EasingMode="EaseOut"/></EasingDoubleKeyFrame.EasingFunction>
                </EasingDoubleKeyFrame>
            </DoubleAnimationUsingKeyFrames>
            <DoubleAnimationUsingKeyFrames Storyboard.TargetName="MainContainer" 
                                           Storyboard.TargetProperty="(UIElement.RenderTransform).(TransformGroup.Children)[0].(ScaleTransform.ScaleY)">
                <EasingDoubleKeyFrame KeyTime="0:0:0" Value="1.0"/>
                <EasingDoubleKeyFrame KeyTime="0:0:0.2" Value="0.7"/>
                <EasingDoubleKeyFrame KeyTime="0:0:0.25" Value="1.0">
                    <EasingDoubleKeyFrame.EasingFunction><CubicEase EasingMode="EaseOut"/></EasingDoubleKeyFrame.EasingFunction>
                </EasingDoubleKeyFrame>
            </DoubleAnimationUsingKeyFrames>
        </Storyboard>
    </UserControl.Resources>
    
    <!-- Context Menu for folders -->
    <UserControl.ContextMenu>
        <ContextMenu x:Name="FolderContextMenu">
            <MenuItem Header="Enlarge Folder" x:Name="EnlargeMenuItem" Click="EnlargeFolder_Click"/>
            <MenuItem Header="Shrink Folder" x:Name="ShrinkMenuItem" Click="ShrinkFolder_Click"/>
        </ContextMenu>
    </UserControl.ContextMenu>
    
    <!-- Main Container with RenderTransform for animations -->
    <Grid x:Name="MainContainer" RenderTransformOrigin="0.5,0.5">
        <Grid.RenderTransform>
            <TransformGroup>
                <ScaleTransform ScaleX="1" ScaleY="1"/>
                <SkewTransform/>
                <RotateTransform Angle="0"/>
                <TranslateTransform/>
            </TransformGroup>
        </Grid.RenderTransform>
        
        <!-- ========== REGULAR APP (Not a folder) ========== -->
        <Grid Width="70" Height="90" 
              Visibility="{Binding IsFolder, Converter={StaticResource BoolToVis}, ConverterParameter=Inverse}">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
            </Grid.RowDefinitions>
            
            <!-- Floating icon without background -->
            <Border Grid.Row="0" Width="60" Height="60" Background="Transparent" 
                    Margin="0,0,0,5" x:Name="IconBorder">
                <Image Source="{Binding IconImage}" Width="48" Height="48" x:Name="ImgIcon" Stretch="Uniform"/>
            </Border>
            
            <TextBlock Grid.Row="1" Text="{Binding Name}" 
                       HorizontalAlignment="Center" Foreground="White" FontSize="11" 
                       TextTrimming="CharacterEllipsis" VerticalAlignment="Top"/>
        </Grid>
        
        <!-- ========== FOLDER: ENLARGED MODE (3x3 with quick-launch) ========== -->
        <Grid x:Name="EnlargedFolderGrid" Width="180" Height="200" Panel.ZIndex="10"
              Visibility="Collapsed">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
            </Grid.RowDefinitions>
            
            <Border Grid.Row="0" Style="{StaticResource FrostedGlassStyle}" 
                    Width="170" Height="170" Margin="0,0,0,5">
                <UniformGrid Rows="3" Columns="3" Margin="8">
                    <!-- Slot 0 -->
                    <Button Style="{StaticResource QuickLaunchSlot}" Click="QuickLaunch_Click" Tag="0">
                        <Image Source="{Binding InnerItems[0].IconImage}" Width="42" Height="42" Stretch="Uniform"/>
                    </Button>
                    <!-- Slot 1 -->
                    <Button Style="{StaticResource QuickLaunchSlot}" Click="QuickLaunch_Click" Tag="1">
                        <Image Source="{Binding InnerItems[1].IconImage}" Width="42" Height="42" Stretch="Uniform"/>
                    </Button>
                    <!-- Slot 2 -->
                    <Button Style="{StaticResource QuickLaunchSlot}" Click="QuickLaunch_Click" Tag="2">
                        <Image Source="{Binding InnerItems[2].IconImage}" Width="42" Height="42" Stretch="Uniform"/>
                    </Button>
                    <!-- Slot 3 -->
                    <Button Style="{StaticResource QuickLaunchSlot}" Click="QuickLaunch_Click" Tag="3">
                        <Image Source="{Binding InnerItems[3].IconImage}" Width="42" Height="42" Stretch="Uniform"/>
                    </Button>
                    <!-- Slot 4 -->
                    <Button Style="{StaticResource QuickLaunchSlot}" Click="QuickLaunch_Click" Tag="4">
                        <Image Source="{Binding InnerItems[4].IconImage}" Width="42" Height="42" Stretch="Uniform"/>
                    </Button>
                    <!-- Slot 5 -->
                    <Button Style="{StaticResource QuickLaunchSlot}" Click="QuickLaunch_Click" Tag="5">
                        <Image Source="{Binding InnerItems[5].IconImage}" Width="42" Height="42" Stretch="Uniform"/>
                    </Button>
                    <!-- Slot 6 -->
                    <Button Style="{StaticResource QuickLaunchSlot}" Click="QuickLaunch_Click" Tag="6">
                        <Image Source="{Binding InnerItems[6].IconImage}" Width="42" Height="42" Stretch="Uniform"/>
                    </Button>
                    <!-- Slot 7 -->
                    <Button Style="{StaticResource QuickLaunchSlot}" Click="QuickLaunch_Click" Tag="7">
                        <Image Source="{Binding InnerItems[7].IconImage}" Width="42" Height="42" Stretch="Uniform"/>
                    </Button>
                    <!-- Slot 8: Subfolder preview (extras) - dynamic binding -->
                    <Border x:Name="SubfolderSlot" Background="#25000000" CornerRadius="8" 
                            Cursor="Hand" MouseLeftButtonUp="SubfolderSlot_Click"
                            ToolTip="More apps..."
                            Visibility="{Binding HasExtras, Converter={StaticResource BoolToVis}}">
                        <Viewbox Stretch="Uniform" Margin="2">
                            <ItemsControl ItemsSource="{Binding ExtraItemsPreview}" Width="48" Height="48">
                                <ItemsControl.ItemsPanel>
                                    <ItemsPanelTemplate>
                                        <UniformGrid Rows="3" Columns="3"/>
                                    </ItemsPanelTemplate>
                                </ItemsControl.ItemsPanel>
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate>
                                        <Image Source="{Binding IconImage}" Width="14" Height="14" Margin="1" Stretch="Uniform"/>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                        </Viewbox>
                    </Border>
                </UniformGrid>
            </Border>
            
            <TextBlock Grid.Row="1" Text="{Binding Name}" 
                       HorizontalAlignment="Center" Foreground="White" FontSize="12" FontWeight="SemiBold"
                       TextTrimming="CharacterEllipsis" VerticalAlignment="Top"/>
        </Grid>
        
        <!-- ========== FOLDER: SHRUNK/COMPACT MODE (3x3 all apps preview) ========== -->
        <Grid x:Name="ShrunkFolderGrid" Width="70" Height="90"
              Visibility="Collapsed">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
            </Grid.RowDefinitions>
            
            <Border Grid.Row="0" Style="{StaticResource FrostedGlassStyle}" 
                    Width="60" Height="60" Margin="0,0,0,5"
                    MouseLeftButtonUp="ShrunkFolder_Click" Cursor="Hand" x:Name="ShrunkBorder">
                <Viewbox Stretch="Uniform" Margin="4">
                    <UniformGrid Rows="3" Columns="3" Width="48" Height="48">
                        <Image Source="{Binding InnerItems[0].IconImage}" Width="14" Height="14" Margin="1"/>
                        <Image Source="{Binding InnerItems[1].IconImage}" Width="14" Height="14" Margin="1"/>
                        <Image Source="{Binding InnerItems[2].IconImage}" Width="14" Height="14" Margin="1"/>
                        <Image Source="{Binding InnerItems[3].IconImage}" Width="14" Height="14" Margin="1"/>
                        <Image Source="{Binding InnerItems[4].IconImage}" Width="14" Height="14" Margin="1"/>
                        <Image Source="{Binding InnerItems[5].IconImage}" Width="14" Height="14" Margin="1"/>
                        <Image Source="{Binding InnerItems[6].IconImage}" Width="14" Height="14" Margin="1"/>
                        <Image Source="{Binding InnerItems[7].IconImage}" Width="14" Height="14" Margin="1"/>
                        <Image Source="{Binding InnerItems[8].IconImage}" Width="14" Height="14" Margin="1"/>
                    </UniformGrid>
                </Viewbox>
            </Border>
            
            <TextBlock Grid.Row="1" Text="{Binding Name}" 
                       HorizontalAlignment="Center" Foreground="White" FontSize="11" 
                       TextTrimming="CharacterEllipsis" VerticalAlignment="Top"/>
        </Grid>
    </Grid>
</UserControl>
